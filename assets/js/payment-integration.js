class PaymentIntegration{constructor(){this.paypalClientId='AYm6LcC6c6Xy6Xy6Xy6Xy6Xy6Xy6Xy6Xy6Xy6Xy6Xy6Xy6Xy6Xy6Xy6Xy';this.merchantInfo={nequi:'+573006677447',daviplata:'+573006677447',email:'pagos@academiadelvallenato.com'};this.init();}
init(){this.setupEventListeners();this.loadPayPalSDK();this.initializeStats();}
setupEventListeners(){document.addEventListener('DOMContentLoaded',()=>{this.handlePaymentMethodChanges();this.setupFormValidation();});}
loadPayPalSDK(){const e=document.createElement('script');e.src=`https://www.paypal.com/sdk/js?client-id=${this.paypalClientId}&currency=COP`;e.addEventListener('load',()=>this.initializePayPal());document.head.appendChild(e);}
initializePayPal(){if(typeof paypal=='undefined')return;try{paypal.Buttons({style:{layout:'vertical',color:'gold',shape:'rect',label:'paypal'},createOrder:(e,t)=>{return t.order.create({purchase_units:[{amount:{value:this.getOrderTotal(),currency_code:'COP'},description:'Clases de Vallenato - Academia Cartagena'}],application_context:{shipping_preference:'NO_SHIPPING'}});},onApprove:(e,t)=>{return t.order.capture().then(e=>{this.handlePayPalSuccess(e);});},onError:e=>{this.handlePaymentError('PayPal',e);},onCancel:e=>{this.trackEvent('payment_cancelled',{method:'paypal'});}}).render('#paypal-button-container');}catch(e){console.error('Error initializing PayPal:',e);}}
initializeStats(){window.statsSystem&&window.statsSystem.trackEvent('payment_system_loaded');}
handlePaymentMethodChanges(){document.querySelectorAll('.payment-method-option').forEach(e=>{e.addEventListener('click',t=>{const o=t.currentTarget.getAttribute('data-method');this.selectPaymentMethod(o);});});}
selectPaymentMethod(e){document.querySelectorAll('.payment-method-option').forEach(t=>{t.classList.remove('selected');});const t=document.querySelector(`[data-method="${e}"]`);t&&t.classList.add('selected'),this.showPaymentDetails(e);const o=document.getElementById('payButton');o&&(o.disabled=!1,o.textContent=this.getPayButtonText(e)),this.trackEvent('payment_method_selected',{method:e});}
showPaymentDetails(e){document.querySelectorAll('.payment-details').forEach(t=>{t.style.display='none';});const t=document.getElementById(`${e}-details`);t&&(t.style.display='block'),('nequi'==e||'daviplata'==e)&&this.generateQRCode(e);}
generateQRCode(e){const t=this.getOrderTotal(),o=this.merchantInfo[e];let n='';'nequi'==e?n=`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=nequi:${o}?amount=${t}`:'daviplata'==e&&(n=`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=daviplata:${o}?amount=${t}`);const c=document.getElementById(`${e}-qr-code`);c&&(c.innerHTML=`<img src="${n}" alt="QR Code ${e}" class="qr-code">`);}
getPayButtonText(e){const t={paypal:'Pagar con PayPal',nequi:'Continuar con Nequi',daviplata:'Continuar con Daviplata'};return t[e]||'Proceder al Pago';}
setupFormValidation(){document.querySelectorAll('form[data-validate="true"]').forEach(e=>{e.addEventListener('submit',t=>{this.validateForm(e)||(t.preventDefault(),this.showFormErrors(e));});e.querySelectorAll('input[required], select[required]').forEach(t=>{t.addEventListener('blur',()=>{this.validateField(t);});});});}
validateForm(e){let t=!0;return e.querySelectorAll('input[required], select[required]').forEach(e=>{this.validateField(e)||(t=!1);}),t;}
validateField(e){const t=e.value.trim();let o=!0,n='';this.clearFieldError(e);switch(e.type){case'email':this.isValidEmail(t)||(o=!1,n='Por favor ingresa un correo electrónico válido');break;case'tel':this.isValidPhone(t)||(o=!1,n='Por favor ingresa un número de teléfono válido (10 dígitos)');break;default:t||(o=!1,n='Este campo es obligatorio');}return o?this.showFieldSuccess(e):this.showFieldError(e,n),o;}
isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);}
isValidPhone(e){return e.replace(/\D/g,'').length>=10;}
showFieldError(e,t){e.classList.add('error');let o=e.parentNode.querySelector('.error-message');o||(o=document.createElement('div'),o.className='error-message',e.parentNode.appendChild(o)),o.textContent=t,o.style.display='block';}
clearFieldError(e){e.classList.remove('error');const t=e.parentNode.querySelector('.error-message');t&&(t.style.display='none');}
showFieldSuccess(e){e.classList.remove('error'),e.classList.add('success');}
showFormErrors(e){const t=e.querySelector('.error');t&&(t.scrollIntoView({behavior:'smooth',block:'center'}),t.focus());}
getOrderTotal(){const e=document.querySelector('.order-total');if(e){const t=e.textContent||e.innerText,o=parseFloat(t.replace(/[^0-9.]/g,''));return isNaN(o)?200000:o;}return 200000;}
async processPayment(e,t){this.showLoading();try{switch(e){case'paypal':await this.processPayPalPayment(t);break;case'nequi':await this.processNequiPayment(t);break;case'daviplata':await this.processDaviplataPayment(t);break;default:throw new Error('Método de pago no soportado');}
this.trackEvent('payment_processed',{method:e,status:'success'});}catch(o){this.handlePaymentError(e,o),this.trackEvent('payment_processed',{method:e,status:'error',error:o.message});}finally{this.hideLoading();}}
async processPayPalPayment(e){return new Promise(e=>{setTimeout(e,1e3);});}
async processNequiPayment(e){return new Promise(e=>{setTimeout(()=>{this.generateNequiInstructions(t),e();},1500);});}
async processDaviplataPayment(e){return new Promise(e=>{setTimeout(()=>{this.generateDaviplataInstructions(t),e();},1500);});}
generateNequiInstructions(e){const t=this.getOrderTotal(),o=`<div class="payment-instructions"><h4><i class="fas fa-mobile-alt"></i> Instrucciones para Pagar con Nequi</h4><div class="instruction-steps"><div class="step"><span class="step-number">1</span><span>Abre la app de Nequi</span></div><div class="step"><span class="step-number">2</span><span>Selecciona "Enviar plata"</span></div><div class="step"><span class="step-number">3</span><span>Número: <strong>+57 300 667 7447</strong></span></div><div class="step"><span class="step-number">4</span><span>Monto: <strong>$${this.formatCurrency(t)} COP</strong></span></div><div class="step"><span class="step-number">5</span><span>Confirma transacción</span></div></div><div class="qr-container"><div id="nequi-qr-code"></div><p><small>Escanea el código QR</small></p></div><div class="whatsapp-confirmation"><p>Envía comprobante por WhatsApp:</p><a href="https://wa.me/573006677447?text=Hola,%20acabo%20de%20realizar%20un%20pago%20por%20Nequi%20por%20valor%20de%20${t}%20COP%20para%20las%20clases%20de%20vallenato" class="btn whatsapp-confirm" target="_blank"><i class="fab fa-whatsapp"></i> Enviar Comprobante</a></div></div>`;this.showPaymentInstructions(o,'nequi');}
generateDaviplataInstructions(e){const t=this.getOrderTotal(),o=`<div class="payment-instructions"><h4><i class="fas fa-wallet"></i> Instrucciones para Pagar con Daviplata</h4><div class="instruction-steps"><div class="step"><span class="step-number">1</span><span>Abre la app de Daviplata</span></div><div class="step"><span class="step-number">2</span><span>Selecciona "Enviar dinero"</span></div><div class="step"><span class="step-number">3</span><span>Número: <strong>+57 300 667 7447</strong></span></div><div class="step"><span class="step-number">4</span><span>Monto: <strong>$${this.formatCurrency(t)} COP</strong></span></div><div class="step"><span class="step-number">5</span><span>Confirma transacción</span></div></div><div class="qr-container"><div id="daviplata-qr-code"></div><p><small>Escanea el código QR</small></p></div><div class="whatsapp-confirmation"><p>Envía comprobante por WhatsApp:</p><a href="https://wa.me/573006677447?text=Hola,%20acabo%20de%20realizar%20un%20pago%20por%20Daviplata%20por%20valor%20de%20${t}%20COP%20para%20las%20clases%20de%20vallenato" class="btn whatsapp-confirm" target="_blank"><i class="fab fa-whatsapp"></i> Enviar Comprobante</a></div></div>`;this.showPaymentInstructions(o,'daviplata');}
showPaymentInstructions(e,t){let o=document.getElementById('payment-instructions-container');o||(o=document.createElement('div'),o.id='payment-instructions-container',o.className='payment-instructions-container',document.querySelector('.payment-details.active').appendChild(o)),o.innerHTML=e,this.generateQRCode(t);}
handlePayPalSuccess(e){const t={paymentMethod:'paypal',transactionId:e.id,payer:e.payer,amount:this.getOrderTotal(),status:'completed',timestamp:new Date().toISOString()};this.saveOrderData(t),this.redirectToConfirmation('success','paypal'),this.trackEvent('payment_success',{method:'paypal',transactionId:e.id,amount:this.getOrderTotal()});}
handlePaymentError(e,t){console.error(`Payment error (${e}):`,t),this.showErrorNotification(`Error en el pago con ${e}. Por favor intenta nuevamente.`),this.trackEvent('payment_error',{method:e,error:t.message});}
showErrorNotification(e){const t=document.createElement('div');t.className='payment-error-notification',t.innerHTML=`<div class="error-content"><i class="fas fa-exclamation-triangle"></i><span>${e}</span><button class="close-error">&times;</button></div>`,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t);},5e3),t.querySelector('.close-error').addEventListener('click',()=>{t.parentNode.removeChild(t);});}
showLoading(){let e=document.getElementById('payment-loading');e||(e=document.createElement('div'),e.id='payment-loading',e.className='payment-loading',e.innerHTML='<div class="loading-spinner"><div class="spinner"></div><p>Procesando tu pago...</p><p><small>No cierres esta ventana</small></p></div>',document.body.appendChild(e)),e.style.display='flex';}
hideLoading(){const e=document.getElementById('payment-loading');e&&(e.style.display='none');}
saveOrderData(e){const t={...e,orderId:'ORD-'+Date.now(),customer:this.getCustomerData(),products:this.getOrderProducts(),timestamp:new Date().toISOString()};return localStorage.setItem('lastOrder',JSON.stringify(t)),t.orderId;}
getCustomerData(){return{firstName:document.getElementById('firstName')?.value||'',lastName:document.getElementById('lastName')?.value||'',email:document.getElementById('email')?.value||'',phone:document.getElementById('phone')?.value||'',address:document.getElementById('address')?.value||''};}
getOrderProducts(){return[{name:'Clases de Acordeón - Mensual',price:2e5,quantity:1}];}
redirectToConfirmation(e,t){const o=this.saveOrderData({paymentMethod:t,status:e,amount:this.getOrderTotal()});window.location.href=`confirmacion-pago.html?status=${e}&method=${t}&order=${o}`;}
formatCurrency(e){return new Intl.NumberFormat('es-CO',{minimumFractionDigits:0}).format(e);}
trackEvent(e,t){window.statsSystem&&window.statsSystem.trackEvent(e,t),typeof gtag!='undefined'&&gtag('event',e,t),console.log('Event tracked:',e,t);}}
const paymentStyles=`.payment-loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:9999}.loading-spinner{background:#fff;padding:2rem;border-radius:12px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.3)}.spinner{width:50px;height:50px;border:5px solid #f3f3f3;border-left:5px solid #d4af37;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.payment-error-notification{position:fixed;top:20px;right:20px;background:#c44536;color:#fff;padding:1rem;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:1e4;max-width:400px}.error-content{display:flex;align-items:center;gap:.5rem}.close-error{background:0;border:0;color:#fff;font-size:1.2rem;cursor:pointer;margin-left:auto}.payment-instructions-container{margin-top:1.5rem;padding:1.5rem;background:#f8f9fa;border-radius:8px;border-left:4px solid #25D366}.instruction-steps{display:flex;flex-direction:column;gap:1rem;margin:1.5rem 0}.step{display:flex;align-items:center;gap:1rem;padding:.75rem;background:#fff;border-radius:6px}.step-number{width:30px;height:30px;background:#d4af37;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0}.qr-container{text-align:center;margin:1.5rem 0}.qr-code{max-width:200px;height:auto;border:1px solid #ddd;border-radius:8px;padding:1rem;background:#fff}.whatsapp-confirmation{text-align:center;margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid #ddd}.form-control.error{border-color:#c44536}.form-control.success{border-color:#25D366}.error-message{color:#c44536;font-size:.875rem;margin-top:.25rem;display:none}`;const styleSheet=document.createElement('style');styleSheet.textContent=paymentStyles,document.head.appendChild(styleSheet),document.addEventListener('DOMContentLoaded',()=>{window.paymentSystem=new PaymentIntegration});
