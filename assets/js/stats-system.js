class StatsSystem{constructor(){this.stats={totalVisits:0,pageViews:{},userSessions:{},conversions:0,bounceRate:0,avgSessionTime:0};this.sessionStart=Date.now();this.currentPage=this.getCurrentPage();this.isPanelVisible=!1;this.init();}
init(){this.loadStats();this.trackPageView();this.setupSessionTracking();this.setupStatsPanel();this.setupStatsToggle();this.setupRealTimeTracking();console.log('ðŸ“Š StatsSystem - Sistema de estadÃ­sticas inicializado');}
trackPageView(){this.stats.totalVisits++,this.stats.pageViews[this.currentPage]=(this.stats.pageViews[this.currentPage]||0)+1,this.saveStats(),this.updateStatsDisplay(),console.log(`ðŸ“ˆ PÃ¡gina vista: ${this.currentPage}`);}
setupSessionTracking(){const e=this.generateSessionId();this.stats.userSessions[e]={startTime:this.sessionStart,pages:[this.currentPage],events:[]};let t=this.currentPage;const o=new MutationObserver(()=>{const e=this.getCurrentPage();e!==t&&(this.trackPageChange(t,e,o),t=e);});o.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener('beforeunload',()=>{this.trackSessionEnd(e);});}
trackPageChange(e,t,o){this.stats.userSessions[o]&&(this.stats.userSessions[o].pages.push(t),this.saveStats());}
trackSessionEnd(e){if(this.stats.userSessions[e]){const t=this.stats.userSessions[e];t.endTime=Date.now(),t.duration=t.endTime-t.startTime,this.calculateSessionMetrics(),this.saveStats();}}
calculateSessionMetrics(){const e=Object.values(this.stats.userSessions);if(0!==e.length){const t=e.reduce((e,t)=>e+(t.duration||0),0);this.stats.avgSessionTime=t/e.length;const o=e.filter(e=>e.pages.length<=1).length;this.stats.bounceRate=o/e.length*100;}}
trackEvent(e,t={}){const o={type:e,data:t,timestamp:Date.now(),page:this.currentPage},n=this.getLatestSession();n&&n.events.push(o),'conversion'===e&&(this.stats.conversions++,this.trackConversion(t)),this.saveStats(),this.updateStatsDisplay(),console.log(`ðŸŽ¯ Evento trackeado: ${e}`,t);}
trackConversion(e){const t={type:e.type||'general',value:e.value||0,timestamp:Date.now(),page:this.currentPage};this.stats.conversionsByType||(this.stats.conversionsByType={}),this.stats.conversionsByType[t.type]||(this.stats.conversionsByType[t.type]=[]),this.stats.conversionsByType[t.type].push(t),this.dispatchEvent('conversion',t);}
setupStatsPanel(){this.createStatsPanel(),this.setupPanelInteractions();}
createStatsPanel(){if(!document.getElementById('stats-panel')){const e=document.createElement('div');e.id='stats-panel',e.className='stats-panel',e.setAttribute('aria-hidden','true'),e.hidden=!0,e.innerHTML=`<div class="stats-header"><h3>ðŸ“Š EstadÃ­sticas del Sitio</h3><button id="close-stats" class="close-stats" aria-label="Cerrar panel de estadÃ­sticas"><i class="fas fa-times"></i></button></div><div class="stats-content"><div class="stats-grid"><div class="stat-card"><div class="stat-icon"><i class="fas fa-users"></i></div><div class="stat-info"><span class="stat-value" id="stat-total-visits">0</span><span class="stat-label">Visitas Totales</span></div></div><div class="stat-card"><div class="stat-icon"><i class="fas fa-chart-line"></i></div><div class="stat-info"><span class="stat-value" id="stat-conversions">0</span><span class="stat-label">Conversiones</span></div></div><div class="stat-card"><div class="stat-icon"><i class="fas fa-clock"></i></div><div class="stat-info"><span class="stat-value" id="stat-avg-time">0s</span><span class="stat-label">Tiempo Promedio</span></div></div><div class="stat-card"><div class="stat-icon"><i class="fas fa-sign-out-alt"></i></div><div class="stat-info"><span class="stat-value" id="stat-bounce-rate">0%</span><span class="stat-label">Tasa de Rebote</span></div></div></div><div class="stats-sections"><div class="stats-section"><h4>ðŸ“ˆ PÃ¡ginas MÃ¡s Visitadas</h4><div class="pages-list" id="top-pages-list"><div class="loading">Cargando...</div></div></div><div class="stats-section"><h4>ðŸŽ¯ Conversiones por Tipo</h4><div class="conversions-list" id="conversions-list"><div class="loading">Cargando...</div></div></div><div class="stats-section"><h4>ðŸ•’ Sesiones Activas</h4><div class="sessions-info"><span class="session-count" id="active-sessions">0</span><span>sesiones activas</span></div></div></div><div class="stats-actions"><button id="export-stats" class="btn btn-outline"><i class="fas fa-download"></i> Exportar Datos</button><button id="reset-stats" class="btn btn-outline"><i class="fas fa-trash"></i> Reiniciar Stats</button></div></div>`,document.body.appendChild(e),this.injectPanelStyles();}}
injectPanelStyles(){if(!document.getElementById('stats-panel-styles')){const e=document.createElement('style');e.id='stats-panel-styles',e.textContent='.stats-panel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:800px;max-height:80vh;background:#fff;border-radius:12px;box-shadow:0 20px 25px rgba(0,0,0,0.1);z-index:10000;opacity:0;visibility:hidden;transition:all .3s ease;display:flex;flex-direction:column}.stats-panel.visible{opacity:1;visibility:visible}.stats-header{display:flex;justify-content:space-between;align-items:center;padding:1.5rem;background:#2c3e50;color:#fff;border-radius:12px 12px 0 0}.stats-header h3{margin:0;font-size:1.25rem}.close-stats{background:0;border:0;color:#fff;font-size:1.25rem;cursor:pointer;padding:.5rem;border-radius:50%;transition:background .3s ease}.close-stats:hover{background:rgba(255,255,255,0.1)}.stats-content{padding:1.5rem;overflow-y:auto;flex:1}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:2rem}.stat-card{display:flex;align-items:center;gap:1rem;padding:1rem;background:#f8f9fa;border-radius:8px;border-left:4px solid #d4af37}.stat-icon{width:40px;height:40px;background:#d4af37;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff}.stat-info{display:flex;flex-direction:column}.stat-value{font-size:1.5rem;font-weight:700;color:#2c3e50}.stat-label{font-size:.875rem;color:#6c757d}.stats-sections{display:grid;gap:1.5rem;margin-bottom:2rem}.stats-section h4{margin:0 0 1rem;color:#2c3e50;font-size:1rem}.pages-list,.conversions-list{background:#f8f9fa;border-radius:8px;padding:1rem;max-height:200px;overflow-y:auto}.page-item,.conversion-item{display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid #dee2e6}.page-item:last-child,.conversion-item:last-child{border-bottom:0}.sessions-info{text-align:center;padding:2rem;background:#f8f9fa;border-radius:8px}.session-count{font-size:2rem;font-weight:700;color:#d4af37;display:block}.stats-actions{display:flex;gap:1rem;justify-content:center}.loading{text-align:center;color:#6c757d;font-style:italic}@media (max-width:768px){.stats-grid{grid-template-columns:1fr 1fr}.stats-actions{flex-direction:column}}@media (max-width:480px){.stats-grid{grid-template-columns:1fr}}',document.head.appendChild(e);}}
setupPanelInteractions(){document.getElementById('close-stats')?.addEventListener('click',()=>{this.hideStatsPanel();}),document.getElementById('stats-panel')?.addEventListener('click',e=>{'stats-panel'===e.target.id&&this.hideStatsPanel();}),document.getElementById('export-stats')?.addEventListener('click',()=>{this.exportStats();}),document.getElementById('reset-stats')?.addEventListener('click',()=>{this.resetStats();});}
setupStatsToggle(){if(!document.querySelector('.stats-toggle')){const e=document.createElement('button');e.className='stats-toggle',e.innerHTML='<i class="fas fa-chart-bar"></i>',e.setAttribute('aria-label','Mostrar estadÃ­sticas'),e.title='EstadÃ­sticas del Sitio',e.style.cssText='position:fixed;bottom:100px;left:20px;width:50px;height:50px;background:#d4af37;color:#fff;border:0;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.25rem;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:9999;transition:all .3s ease',e.addEventListener('mouseenter',()=>{e.style.transform='scale(1.1)',e.style.boxShadow='0 6px 8px rgba(0,0,0,0.15)'}),e.addEventListener('mouseleave',()=>{e.style.transform='scale(1)',e.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'}),e.addEventListener('click',()=>{this.toggleStatsPanel();}),document.body.appendChild(e);}}
toggleStatsPanel(){this.isPanelVisible?this.hideStatsPanel():this.showStatsPanel();}
showStatsPanel(){const e=document.getElementById('stats-panel');e&&(e.classList.add('visible'),e.removeAttribute('hidden'),e.setAttribute('aria-hidden','false'),this.isPanelVisible=!0,this.updateStatsDisplay());}
hideStatsPanel(){const e=document.getElementById('stats-panel');e&&(e.classList.remove('visible'),e.setAttribute('aria-hidden','true'),this.isPanelVisible=!1,setTimeout(()=>{e.hidden=!0;},300));}
updateStatsDisplay(){this.updateBasicStats(),this.updatePagesList(),this.updateConversionsList(),this.updateSessionsInfo();}
updateBasicStats(){const e=document.getElementById('stat-total-visits'),t=document.getElementById('stat-conversions'),o=document.getElementById('stat-avg-time'),n=document.getElementById('stat-bounce-rate');e&&(e.textContent=this.stats.totalVisits.toLocaleString()),t&&(t.textContent=this.stats.conversions.toLocaleString()),o&&(o.textContent=`${Math.round(this.stats.avgSessionTime/1e3)}s`),n&&(n.textContent=`${Math.round(this.stats.bounceRate)}%`);}
updatePagesList(){const e=document.getElementById('top-pages-list');if(e){const t=Object.entries(this.stats.pageViews).sort((e,t)=>t[1]-e[1]).slice(0,10);0===t.length?e.innerHTML='<div class="loading">No hay datos disponibles</div>':e.innerHTML=t.map(([e,t])=>`<div class="page-item"><span class="page-name">${this.getPageDisplayName(e)}</span><span class="page-views">${t.toLocaleString()} vistas</span></div>`).join('');}}
updateConversionsList(){const e=document.getElementById('conversions-list');if(e){this.stats.conversionsByType&&Object.keys(this.stats.conversionsByType).length>0?e.innerHTML=Object.entries(this.stats.conversionsByType).map(([e,t])=>`<div class="conversion-item"><span class="conversion-type">${this.getConversionDisplayName(e)}</span><span class="conversion-count">${t.length}</span></div>`).join(''):e.innerHTML='<div class="loading">No hay conversiones registradas</div>';}}
updateSessionsInfo(){const e=document.getElementById('active-sessions');if(e){const t=Object.values(this.stats.userSessions).filter(e=>!e.endTime).length;e.textContent=t;}}
saveStats(){try{localStorage.setItem('academia-stats',JSON.stringify(this.stats));}catch(e){console.error('Error guardando estadÃ­sticas:',e);}}
loadStats(){try{const e=localStorage.getItem('academia-stats');e&&(this.stats={...this.stats,...JSON.parse(e)});}catch(e){console.error('Error cargando estadÃ­sticas:',e);}}
exportStats(){const e=JSON.stringify(this.stats,null,2),t=new Blob([e],{type:'application/json'}),o=URL.createObjectURL(t),n=document.createElement('a');n.href=o,n.download=`estadisticas-academia-${new Date().toISOString().split('T')[0]}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o),this.trackEvent('stats_exported');}
resetStats(){confirm('Â¿EstÃ¡s seguro de que quieres reiniciar todas las estadÃ­sticas? Esta acciÃ³n no se puede deshacer.')&&(this.stats={totalVisits:0,pageViews:{},userSessions:{},conversions:0,bounceRate:0,avgSessionTime:0},this.saveStats(),this.updateStatsDisplay(),this.trackEvent('stats_reset'));}
setupRealTimeTracking(){this.trackImportantClicks(),this.trackFormSubmissions(),this.trackScrollBehavior(),this.trackTimeOnPage();}
trackImportantClicks(){document.addEventListener('click',e=>{const t=e.target.closest('a, button');if(t){(t.classList.contains('btn-primary')||t.classList.contains('whatsapp-float'))&&this.trackEvent('cta_click',{text:t.textContent.trim(),type:t.classList.contains('whatsapp-float')?'whatsapp':'button'});t.classList.contains('nav-link')&&this.trackEvent('navigation_click',{linkText:t.textContent.trim(),href:t.getAttribute('href')});}});}
trackFormSubmissions(){document.addEventListener('submit',e=>{this.trackEvent('form_submission',{formId:e.target.id||'unknown',formAction:e.target.getAttribute('action')||'unknown'});});}
trackScrollBehavior(){let e=0;window.addEventListener('scroll',()=>{const t=window.scrollY,o=document.documentElement.scrollHeight-window.innerHeight,n=(t/o)*100;n>e&&(e=n,n>=25&&e<50?this.trackEvent('scroll_25_percent'):n>=50&&e<75?this.trackEvent('scroll_50_percent'):n>=75&&e<90?this.trackEvent('scroll_75_percent'):n>=90&&this.trackEvent('scroll_90_percent'));});}
trackTimeOnPage(){const e=Date.now();window.addEventListener('beforeunload',()=>{this.trackEvent('page_time',{duration:Date.now()-e,page:this.currentPage});});}
getCurrentPage(){return window.location.pathname.split('/').pop()||'index.html';}
getPageDisplayName(e){const t={'index.html':'ðŸ  Inicio','clases.html':'ðŸŽµ Clases','servicios.html':'âš¡ Servicios','instrumentos.html':'ðŸŽ¹ Instrumentos','contacto.html':'ðŸ“ž Contacto','musica-en-vivo.html':'ðŸŽ¤ MÃºsica en Vivo'};return t[e]||e;}
getConversionDisplayName(e){const t={'contact_form':'ðŸ“§ Formulario Contacto','newsletter':'ðŸ“° Newsletter','whatsapp':'ðŸ’¬ WhatsApp','phone_call':'ðŸ“ž Llamada','class_signup':'ðŸŽµ InscripciÃ³n Clases'};return t[e]||e;}
generateSessionId(){return'session_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);}
getLatestSession(){const e=Object.values(this.stats.userSessions);return e.sort((e,t)=>t.startTime-e.startTime)[0];}
dispatchEvent(e,t){const o=new CustomEvent(`stats:${e}`,{detail:t});document.dispatchEvent(o);}
trackConversion(e,t={}){this.trackEvent('conversion',{type:e,...t});}
getStats(){return{...this.stats};}
destroy(){console.log('ðŸ§¹ StatsSystem - Sistema limpiado');}}
document.addEventListener('DOMContentLoaded',()=>{window.statsSystem=new StatsSystem(),window.trackConversion=(e,t)=>{window.statsSystem&&window.statsSystem.trackConversion(e,t);},console.log('ðŸš€ StatsSystem - Listo para trackear');});
